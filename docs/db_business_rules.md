# Database Business RulesThis document defines business rules as entity relationships, cardinalities, and integrity constraints for `es-stats`.These rules must align with:- `docs/time_rules.md` (authoritative time/session logic)- `docs/schema.md` (schema specification)- `docs/diagrams/erd.md` (conceptual/logical/physical ERDs)---## 1) Entities and relationship rules (cardinality and optionality)### 1.1 Instruments and 1-minute bars- An **Instrument** can have **zero or many** 1-minute bars.- A **1-minute bar** must belong to **exactly one** Instrument.Database intent:- `bars_1m.instrument_id` is required (NOT NULL, FK).- 1-minute bar identity is unique per instrument and timestamp.### 1.2 Instruments and 30-minute bars- An **Instrument** can have **zero or many** 30-minute bars.- A **30-minute bar** must belong to **exactly one** Instrument.Database intent:- `bars_30m.instrument_id` is required (NOT NULL, FK).- 30-minute bar identity is unique per instrument and bucket timestamp.### 1.3 Instruments and import runs- An **Instrument** can have **zero or many** import runs.- An **ImportRun** must belong to **exactly one** Instrument.Database intent:- `imports.instrument_id` is required (NOT NULL, FK).- Import runs exist even if they ultimately fail (status records outcome).### 1.4 Import runs and bars (traceability links)Import-to-bar relationships are optional and exist for auditability; they do not define bar identity.#### 1-minute bars traceability- An **ImportRun** can be associated with **zero or many** 1-minute bars.- A **1-minute bar** can be associated with **zero or one** ImportRun.Database intent:- `bars_1m.source_import_id` is optional (nullable FK).#### 30-minute bars traceability- An **ImportRun** can be associated with **zero or many** 30-minute bars.- A **30-minute bar** can be associated with **zero or one** ImportRun.Database intent:- `bars_30m.derived_from_import_id` is optional (nullable FK).---## 2) Identity and uniqueness rules### 2.1 Instrument identity- Each `symbol` uniquely identifies an Instrument.- An Instrument may exist without any imported data.### 2.2 Canonical bar identity (1-minute)- There is **at most one** 1-minute bar for a given `(instrument_id, ts_start_utc)`.### 2.3 Derived bar identity (30-minute)- There is **at most one** 30-minute bar for a given `(instrument_id, bucket_start_utc)`.---## 3) Time and derived-field rules### 3.1 Canonical timestamp representation- Bar timestamps are stored as epoch seconds (INTEGER) representing the bar **start instant**:  - `bars_1m.ts_start_utc`  - `bars_30m.bucket_start_utc`### 3.2 Import timestamp interpretation (DST-aware)- Source timestamps are interpreted in a selectable `input_timezone` (default `America/Chicago`) and converted to epoch seconds for storage.- The import process is responsible for correct DST-aware parsing and conversion.### 3.3 Required CT helper fieldsTo avoid runtime timezone conversion in analytics and keep queries index-friendly:- `trading_date_ct_int` is computed using CT 17:00 rollover (see `docs/time_rules.md`).- `ct_minute_of_day` (and `bucket_ct_minute_of_day` for 30m) is computed in CT and stored as an integer 0..1439.---## 4) Session and period rules (analytics-oriented)### 4.1 Session boundaries (CT)Sessions are defined in `docs/time_rules.md` and must be applied consistently:- ON: 17:00:00–08:29:59 CT- RTH: 08:30:00–15:59:59 CT- 16:00:00–16:59:59 CT is out-of-session for v1 unless a report explicitly includes it### 4.2 Period identity (30-minute)- `period_index` is the authoritative identifier for period math and grouping.- `tpo` is a display label derived from `period_index` and session.- Because ON spans 30 periods, `tpo` must allow labels longer than one character if stored.---## 5) OHLCV integrity rulesFor both 1m and 30m bars:- `volume` must be non-negative.- `high` must be >= `low`.- (optional stricter rule) `high` must be >= `open` and `close`, and `low` must be <= `open` and `close`.  - This may be enforced in validation logic rather than hard DB checks if data sources occasionally violate it.---## 6) Merge policy rules (import semantics)The import process supports two behaviors when a bar key already exists:- `skip`:  - Existing bars are not modified.- `overwrite`:  - Existing bars with the same key are updated (OHLCV fields replaced).These behaviors apply to `bars_1m`. Derived `bars_30m` is rebuilt deterministically from canonical bars.---## 7) Derived table rules (1m -> 30m)### 7.1 Derived table nature- `bars_30m` is a deterministic cache derived from `bars_1m`.- It may be deleted/rebuilt over affected ranges without loss of canonical information.### 7.2 Aggregation semanticsFor each 30m bucket:- `open` = `open` of earliest 1m bar in bucket- `close` = `close` of latest 1m bar in bucket- `high` = max(`high`) of 1m bars in bucket- `low` = min(`low`) of 1m bars in bucket- `volume` = sum(`volume`) of 1m bars in bucket- `bar_count_1m` = count of 1m bars in bucket- `is_complete` = 1 iff `bar_count_1m == 30`### 7.3 Partial data policy- Partial buckets/days are allowed and explicitly represented via `bar_count_1m` and `is_complete`.- Analytics must check completeness when needed and must not silently assume a full set of bars.---## 8) Data lifecycle rules- Workload is read-heavy; writes occur during import (expected <= daily).- Import audit records are append-only, with status finalized at the end of an import run.- Derived 30m bars may be rebuilt as part of maintenance or after new canonical data is imported.