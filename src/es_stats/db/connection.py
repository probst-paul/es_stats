from __future__ import annotationsimport sqlite3from contextlib import contextmanagerfrom pathlib import Pathfrom es_stats.config.settings import settingsdef connect_sqlite(db_path: Path) -> sqlite3.Connection:    """    Open a SQLite connection with consistent pragmas.    Notes:    - We enable foreign keys explicitly (SQLite requires this per connection).    - WAL improves read concurrency (useful for a web app).    - busy_timeout reduces 'database is locked' failures under light contention.    """    db_path.parent.mkdir(parents=True, exist_ok=True)    conn = sqlite3.connect(        str(db_path),        detect_types=sqlite3.PARSE_DECLTYPES,        # For web servers, this avoids thread-affinity surprises.        # We should not share the SAME connection across threads/requests.        check_same_thread=False,    )    conn.row_factory = sqlite3.Row    # Pragmas (applied per connection)    conn.execute("PRAGMA foreign_keys = ON;")    conn.execute("PRAGMA journal_mode = WAL;")    conn.execute("PRAGMA synchronous = NORMAL;")    conn.execute("PRAGMA busy_timeout = 5000;")    conn.execute("PRAGMA temp_store = MEMORY;")    return conndef connect_default() -> sqlite3.Connection:    """Connect using configured settings."""    return connect_sqlite(settings.db_path)@contextmanagerdef connection(db_path: Path | None = None):    """    Context manager for a short-lived connection.    Usage:      with connection() as conn:          ...    """    conn = connect_sqlite(db_path or settings.db_path)    try:        yield conn    finally:        conn.close()